(function(){if(!window.capptain)window.capptain={};var w=capptain.Crypto={},y=w.util={rotl:function(h,k){return h<<k|h>>>32-k},rotr:function(h,k){return h<<32-k|h>>>k},endian:function(h){if(h.constructor==Number)return y.rotl(h,8)&16711935|y.rotl(h,24)&4278255360;for(var k=0;k<h.length;k++)h[k]=y.endian(h[k]);return h},randomBytes:function(h){for(var k=[];h>0;h--)k.push(Math.floor(Math.random()*256));return k},bytesToWords:function(h){for(var k=[],j=0,s=0;j<h.length;j++,s+=8)k[s>>>5]|=h[j]<<24-s%
32;return k},wordsToBytes:function(h){for(var k=[],j=0;j<h.length*32;j+=8)k.push(h[j>>>5]>>>24-j%32&255);return k},bytesToHex:function(h){for(var k=[],j=0;j<h.length;j++){k.push((h[j]>>>4).toString(16));k.push((h[j]&15).toString(16))}return k.join("")},hexToBytes:function(h){for(var k=[],j=0;j<h.length;j+=2)k.push(parseInt(h.substr(j,2),16));return k},bytesToBase64:function(h){if(typeof btoa=="function")return btoa(r.bytesToString(h));for(var k=[],j=0;j<h.length;j+=3)for(var s=h[j]<<16|h[j+1]<<8|
h[j+2],c=0;c<4;c++)j*8+c*6<=h.length*8?k.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(s>>>6*(3-c)&63)):k.push("=");return k.join("")},base64ToBytes:function(h){if(typeof atob=="function")return r.stringToBytes(atob(h));h=h.replace(/[^A-Z0-9+\/]/ig,"");for(var k=[],j=0,s=0;j<h.length;s=++j%4)s!=0&&k.push(("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(h.charAt(j-1))&Math.pow(2,-2*s+8)-1)<<s*2|"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(h.charAt(j))>>>
6-s*2);return k}};w.mode={};w=w.charenc={};w.UTF8={stringToBytes:function(h){return r.stringToBytes(unescape(encodeURIComponent(h)))},bytesToString:function(h){return decodeURIComponent(escape(r.bytesToString(h)))}};var r=w.Binary={stringToBytes:function(h){for(var k=[],j=0;j<h.length;j++)k.push(h.charCodeAt(j));return k},bytesToString:function(h){for(var k=[],j=0;j<h.length;j++)k.push(String.fromCharCode(h[j]));return k.join("")}}})();(function(){var w=capptain.Crypto,y=w.util,r=w.charenc,h=r.UTF8,k=r.Binary;w.HMAC=function(j,s,c,a){if(s.constructor==String)s=h.stringToBytes(s);if(c.constructor==String)c=h.stringToBytes(c);if(c.length>j._blocksize*4)c=j(c,{asBytes:true});var b=c.slice(0);c=c.slice(0);for(var f=0;f<j._blocksize*4;f++){b[f]^=92;c[f]^=54}j=j(b.concat(j(c.concat(s),{asBytes:true})),{asBytes:true});return a&&a.asBytes?j:a&&a.asString?k.bytesToString(j):y.bytesToHex(j)}})();(function(){var w=capptain.Crypto,y=w.util,r=w.charenc,h=r.UTF8,k=r.Binary,j=w.SHA1=function(s,c){var a=y.wordsToBytes(j._sha1(s));return c&&c.asBytes?a:c&&c.asString?k.bytesToString(a):y.bytesToHex(a)};j._sha1=function(s){if(s.constructor==String)s=h.stringToBytes(s);var c=y.bytesToWords(s),a=s.length*8;s=[];var b=1732584193,f=-271733879,e=-1732584194,o=271733878,g=-1009589776;c[a>>5]|=128<<24-a%32;c[(a+64>>>9<<4)+15]=a;for(a=0;a<c.length;a+=16){for(var i=b,l=f,n=e,z=o,q=g,u=0;u<80;u++){if(u<16)s[u]=
c[a+u];else{var v=s[u-3]^s[u-8]^s[u-14]^s[u-16];s[u]=v<<1|v>>>31}v=(b<<5|b>>>27)+g+(s[u]>>>0)+(u<20?(f&e|~f&o)+1518500249:u<40?(f^e^o)+1859775393:u<60?(f&e|f&o|e&o)-1894007588:(f^e^o)-899497514);g=o;o=e;e=f<<30|f>>>2;f=b;b=v}b+=i;f+=l;e+=n;o+=z;g+=q}return[b,f,e,o,g]};j._blocksize=16})();capptain.MD5=function(){var w=function(e,o){var g=(e&65535)+(o&65535);return(e>>16)+(o>>16)+(g>>16)<<16|g&65535},y=function(e){for(var o=[],g=0;g<e.length*8;g+=8)o[g>>5]|=(e.charCodeAt(g/8)&255)<<g%32;return o},r=function(e){for(var o="",g=0;g<e.length*32;g+=8)o+=String.fromCharCode(e[g>>5]>>>g%32&255);return o},h=function(e){for(var o="",g=0;g<e.length*4;g++)o+="0123456789abcdef".charAt(e[g>>2]>>g%4*8+4&15)+"0123456789abcdef".charAt(e[g>>2]>>g%4*8&15);return o},k=function(e){for(var o="",g,i,l=0;l<
e.length*4;l+=3){g=(e[l>>2]>>8*(l%4)&255)<<16|(e[l+1>>2]>>8*((l+1)%4)&255)<<8|e[l+2>>2]>>8*((l+2)%4)&255;for(i=0;i<4;i++)o+=l*8+i*6>e.length*32?"":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(g>>6*(3-i)&63)}return o},j=function(e,o,g,i,l,n){e=w(w(o,e),w(i,n));return w(e<<l|e>>>32-l,g)},s=function(e,o,g,i,l,n,z){return j(o&g|~o&i,e,o,l,n,z)},c=function(e,o,g,i,l,n,z){return j(o&i|g&~i,e,o,l,n,z)},a=function(e,o,g,i,l,n,z){return j(g^(o|~i),e,o,l,n,z)},b=function(e,o){e[o>>
5]|=128<<o%32;e[(o+64>>>9<<4)+14]=o;for(var g=1732584193,i=-271733879,l=-1732584194,n=271733878,z,q,u,v,p=0;p<e.length;p+=16){z=g;q=i;u=l;v=n;g=s(g,i,l,n,e[p+0],7,-680876936);n=s(n,g,i,l,e[p+1],12,-389564586);l=s(l,n,g,i,e[p+2],17,606105819);i=s(i,l,n,g,e[p+3],22,-1044525330);g=s(g,i,l,n,e[p+4],7,-176418897);n=s(n,g,i,l,e[p+5],12,1200080426);l=s(l,n,g,i,e[p+6],17,-1473231341);i=s(i,l,n,g,e[p+7],22,-45705983);g=s(g,i,l,n,e[p+8],7,1770035416);n=s(n,g,i,l,e[p+9],12,-1958414417);l=s(l,n,g,i,e[p+10],17,
-42063);i=s(i,l,n,g,e[p+11],22,-1990404162);g=s(g,i,l,n,e[p+12],7,1804603682);n=s(n,g,i,l,e[p+13],12,-40341101);l=s(l,n,g,i,e[p+14],17,-1502002290);i=s(i,l,n,g,e[p+15],22,1236535329);g=c(g,i,l,n,e[p+1],5,-165796510);n=c(n,g,i,l,e[p+6],9,-1069501632);l=c(l,n,g,i,e[p+11],14,643717713);i=c(i,l,n,g,e[p+0],20,-373897302);g=c(g,i,l,n,e[p+5],5,-701558691);n=c(n,g,i,l,e[p+10],9,38016083);l=c(l,n,g,i,e[p+15],14,-660478335);i=c(i,l,n,g,e[p+4],20,-405537848);g=c(g,i,l,n,e[p+9],5,568446438);n=c(n,g,i,l,e[p+14],
9,-1019803690);l=c(l,n,g,i,e[p+3],14,-187363961);i=c(i,l,n,g,e[p+8],20,1163531501);g=c(g,i,l,n,e[p+13],5,-1444681467);n=c(n,g,i,l,e[p+2],9,-51403784);l=c(l,n,g,i,e[p+7],14,1735328473);i=c(i,l,n,g,e[p+12],20,-1926607734);g=j(i^l^n,g,i,e[p+5],4,-378558);n=j(g^i^l,n,g,e[p+8],11,-2022574463);l=j(n^g^i,l,n,e[p+11],16,1839030562);i=j(l^n^g,i,l,e[p+14],23,-35309556);g=j(i^l^n,g,i,e[p+1],4,-1530992060);n=j(g^i^l,n,g,e[p+4],11,1272893353);l=j(n^g^i,l,n,e[p+7],16,-155497632);i=j(l^n^g,i,l,e[p+10],23,-1094730640);
g=j(i^l^n,g,i,e[p+13],4,681279174);n=j(g^i^l,n,g,e[p+0],11,-358537222);l=j(n^g^i,l,n,e[p+3],16,-722521979);i=j(l^n^g,i,l,e[p+6],23,76029189);g=j(i^l^n,g,i,e[p+9],4,-640364487);n=j(g^i^l,n,g,e[p+12],11,-421815835);l=j(n^g^i,l,n,e[p+15],16,530742520);i=j(l^n^g,i,l,e[p+2],23,-995338651);g=a(g,i,l,n,e[p+0],6,-198630844);n=a(n,g,i,l,e[p+7],10,1126891415);l=a(l,n,g,i,e[p+14],15,-1416354905);i=a(i,l,n,g,e[p+5],21,-57434055);g=a(g,i,l,n,e[p+12],6,1700485571);n=a(n,g,i,l,e[p+3],10,-1894986606);l=a(l,n,g,i,
e[p+10],15,-1051523);i=a(i,l,n,g,e[p+1],21,-2054922799);g=a(g,i,l,n,e[p+8],6,1873313359);n=a(n,g,i,l,e[p+15],10,-30611744);l=a(l,n,g,i,e[p+6],15,-1560198380);i=a(i,l,n,g,e[p+13],21,1309151649);g=a(g,i,l,n,e[p+4],6,-145523070);n=a(n,g,i,l,e[p+11],10,-1120210379);l=a(l,n,g,i,e[p+2],15,718787259);i=a(i,l,n,g,e[p+9],21,-343485551);g=w(g,z);i=w(i,q);l=w(l,u);n=w(n,v)}return[g,i,l,n]},f=function(e,o){var g=y(e);if(g.length>16)g=b(g,e.length*8);for(var i=Array(16),l=Array(16),n=0;n<16;n++){i[n]=g[n]^909522486;
l[n]=g[n]^1549556828}g=b(i.concat(y(o)),512+o.length*8);return b(l.concat(g),640)};return{hexdigest:function(e){return h(b(y(e),e.length*8))},b64digest:function(e){return k(b(y(e),e.length*8))},hash:function(e){return r(b(y(e),e.length*8))},hmac_hexdigest:function(e,o){return h(f(e,o))},hmac_b64digest:function(e,o){return k(f(e,o))},hmac_hash:function(e,o){return r(f(e,o))},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72"}}}();if(!Function.prototype.bind)Function.prototype.bind=function(w){var y=this,r=Array.prototype.slice,h=Array.prototype.concat,k=r.call(arguments,1);return function(){return y.apply(w?w:this,h.call(k,r.call(arguments,0)))}};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(w,y){var r=this.length,h=Number(y)||0;h=h<0?Math.ceil(h):Math.floor(h);if(h<0)h+=r;for(;h<r;h++)if(h in this&&this[h]===w)return h;return-1};
(function(w){function y(a,b){return new c.Builder(a,b)}function r(a){return new c.Builder("message",a)}function h(a){return new c.Builder("iq",a)}function k(a){return new c.Builder("presence",a)}var j;(function(){var a=capptain.Crypto,b=a.util,f=a.charenc.Binary;j={encode:function(e){return b.bytesToBase64(f.stringToBytes(e))},decode:function(e){return f.bytesToString(b.base64ToBytes(e))}}})();var s=capptain.MD5,c;c={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",
CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(a,
b){c.NS[a]=b},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,forEachChild:function(a,b,f){var e,o;for(e=0;e<a.childNodes.length;e++){o=a.childNodes[e];if(o.nodeType==c.ElementType.NORMAL&&(!b||this.isTagEqual(o,b)))f(o)}},isTagEqual:function(a,b){return a.tagName.toLowerCase()==b.toLowerCase()},_xmlGenerator:null,
_makeGenerator:function(){var a;if(document.implementation.createDocument)a=document.implementation.createDocument("jabber:client","strophe",null);else if(window.ActiveXObject){a=this._getIEXmlDom();a.appendChild(a.createElement("strophe"))}return a},xmlGenerator:function(){if(!c._xmlGenerator)c._xmlGenerator=c._makeGenerator();return c._xmlGenerator},_getIEXmlDom:function(){for(var a=null,b=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument",
"MSXML.DOMDocument","Microsoft.XMLDOM"],f=0;f<b.length;f++)if(a===null)try{a=new ActiveXObject(b[f])}catch(e){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=c.xmlGenerator().createElement(a),f,e,o;for(f=1;f<arguments.length;f++)if(arguments[f])if(typeof arguments[f]=="string"||typeof arguments[f]=="number")b.appendChild(c.xmlTextNode(arguments[f]));else if(typeof arguments[f]=="object"&&typeof arguments[f].sort=="function")for(e=0;e<arguments[f].length;e++)typeof arguments[f][e]==
"object"&&typeof arguments[f][e].sort=="function"&&b.setAttribute(arguments[f][e][0],arguments[f][e][1]);else if(typeof arguments[f]=="object")for(o in arguments[f])arguments[f].hasOwnProperty(o)&&b.setAttribute(o,arguments[f][o]);return b},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");return a=a.replace(/>/g,"&gt;")},xmlTextNode:function(a){a=c.xmlescape(a);return c.xmlGenerator().createTextNode(a)},getText:function(a){if(!a)return null;var b="";if(a.childNodes.length===
0&&(a.nodeType==c.ElementType.TEXT||a.nodeType==c.ElementType.CDATA))b+=a.nodeValue;for(var f=0;f<a.childNodes.length;f++){var e=a.childNodes[f];if(e.nodeType==c.ElementType.TEXT||e.nodeType==c.ElementType.CDATA)b+=a.childNodes[f].nodeValue}return b},copyElement:function(a){var b,f;if(a.nodeType==c.ElementType.NORMAL){f=c.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)f.setAttribute(a.attributes[b].nodeName.toLowerCase(),a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)f.appendChild(c.copyElement(a.childNodes[b]))}else if(a.nodeType==
c.ElementType.TEXT||a.nodeType==c.ElementType.CDATA)f=c.xmlTextNode(a.nodeValue);return f},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,
":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){if(a.indexOf("@")<0)return null;return a.split("@")[0]},getDomainFromJid:function(a){a=c.getBareJidFromJid(a);if(a.indexOf("@")<0)return a;else{a=a.split("@");a.splice(0,1);return a.join("@")}},getResourceFromJid:function(a){a=a.split("/");if(a.length<2)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},log:function(){},debug:function(a){this.log(this.LogLevel.DEBUG,
a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var b;if(!a)return null;if(typeof a.tree==="function")a=a.tree();var f=a.nodeName,e,o;if(a.getAttribute("_realname"))f=a.getAttribute("_realname");b="<"+f;for(e=0;e<a.attributes.length;e++)if(a.attributes[e].nodeName!="_realname")b+=" "+a.attributes[e].nodeName+"='"+a.attributes[e].value.replace(/&/g,
"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'";if(a.childNodes.length>0){b+=">";for(e=0;e<a.childNodes.length;e++){o=a.childNodes[e];if(o.nodeType==c.ElementType.NORMAL)b+=c.serialize(o);else if(o.nodeType==c.ElementType.TEXT)b+=o.nodeValue;else if(o.nodeType==c.ElementType.CDATA)b+="<![CDATA["+o.nodeValue+"]]\>"}b+="</"+f+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){c._connectionPlugins[a]=b}};c.Builder=function(a,b){if(a=="presence"||
a=="message"||a=="iq")if(b&&!b.xmlns)b.xmlns=c.NS.CLIENT;else b||(b={xmlns:c.NS.CLIENT});this.node=this.nodeTree=c.xmlElement(a,b)};c.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return c.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.node.setAttribute(b,a[b]);return this},c:function(a,b){var f=c.xmlElement(a,b);this.node.appendChild(f);this.node=f;return this},cnode:function(a){var b=
c.xmlGenerator(),f;try{f=b.importNode(a,true)}catch(e){f=c.copyElement(a)}this.node.appendChild(f);this.node=f;return this},t:function(a){this.node.appendChild(c.xmlTextNode(a));return this}};c.Handler=function(a,b,f,e,o,g,i){this.handler=a;this.ns=b;this.name=f;this.type=e;this.id=o;this.options=i||{matchbare:false};if(!this.options.matchBare)this.options.matchBare=false;this.from=this.options.matchBare?g?c.getBareJidFromJid(g):null:g;this.user=true};c.Handler.prototype={isMatch:function(a){var b,
f=null;f=this.options.matchBare?c.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");b=false;if(this.ns){var e=this;c.forEachChild(a,null,function(o){if(o.getAttribute("xmlns")==e.ns)b=true});b=b||a.getAttribute("xmlns")==this.ns}else b=true;if(b&&(!this.name||c.isTagEqual(a,this.name))&&(!this.type||a.getAttribute("type")==this.type)&&(!this.id||a.getAttribute("id")==this.id)&&(!this.from||f==this.from))return true;return false},run:function(a){var b=null;try{b=this.handler(a)}catch(f){if(f.sourceURL)c.fatal("error: "+
this.handler+" "+f.sourceURL+":"+f.line+" - "+f.name+": "+f.message);else if(f.fileName){if(typeof console!="undefined"){console.trace();console.error(this.handler," - error - ",f,f.message)}c.fatal("error: "+this.handler+" "+f.fileName+":"+f.lineNumber+" - "+f.name+": "+f.message)}else c.fatal("error: "+this.handler);throw f;}return b},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};c.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=
(new Date).getTime();this.user=true};c.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};c.Request=function(a,b,f,e){this.id=++c._requestId;this.xmlData=a;this.data=c.serialize(a);this.func=this.origFunc=b;this.rid=f;this.date=NaN;this.sends=e||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date)return 0;
return(new Date-this.date)/1E3};this.timeDead=function(){if(!this.dead)return 0;return(new Date-this.dead)/1E3};this.xhr=this._newXHR()};c.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){a=this.xhr.responseXML.documentElement;if(a.tagName=="parsererror"){c.error("invalid response received");c.error("responseText: "+this.xhr.responseText);c.error("responseXML: "+c.serialize(this.xhr.responseXML));throw"parsererror";}}else if(this.xhr.responseText){c.error("invalid response received");
c.error("responseText: "+this.xhr.responseText);c.error("responseXML: "+c.serialize(this.xhr.responseXML))}return a},_newXHR:function(){var a;if(window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)){if(typeof window.XDomainRequest.prototype.oldsend=="undefined"){XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send;XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments);this.readyState=2;try{this.onreadystatechange()}catch(b){}}}return function(){var b=
new XDomainRequest;b.readyState=0;var f=this.func.bind(null,this);b.onload=function(){b.readyState=4;b.status=200;b.responseXML=new ActiveXObject("Microsoft.XMLDOM");b.responseXML.async="false";b.responseXML.loadXML(b.responseText);f()};b.onerror=function(){c.error("XDR error");b.readyState=4;b.status=400;f()};b.ontimeout=function(){c.error("XDR timeout");b.readyState=4;b.status=400;f()};return b}}else if(window.XMLHttpRequest)return function(){var b=new XMLHttpRequest;b.overrideMimeType&&b.overrideMimeType("text/xml");
b.onreadystatechange=this.func.bind(null,this);return b};else if(window.ActiveXObject)return function(){var b=new ActiveXObject("Microsoft.XMLHTTP");b.onreadystatechange=this.func.bind(null,this);return b};return null}()};c.Connection=function(a){this.service=a;this.jid="";this.rid=Math.floor(Math.random()*4294967295);this.features=this.streamId=this.sid=null;this.do_bind=this.do_session=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=
[];this._disconnectTimeout=this._idleTimeout=null;this.connected=this.disconnecting=this.authenticated=false;this.errors=0;this.paused=false;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*1E4);this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var b in c._connectionPlugins)if(c._connectionPlugins.hasOwnProperty(b)){a=function(){};a.prototype=
c._connectionPlugins[b];this[b]=new a;this[b].init(this)}};c.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.streamId=this.sid=null;this.do_bind=this.do_session=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.connected=this.disconnecting=this.authenticated=false;this.errors=0;this._requests=[];this._uniqueId=Math.round(Math.random()*1E4)},pause:function(){this.paused=true},
resume:function(){this.paused=false},getUniqueId:function(a){return typeof a=="string"||typeof a=="number"?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,b,f,e,o){this.jid=a;this.pass=b;this.connect_callback=f;this.authenticated=this.connected=this.disconnecting=false;this.errors=0;this.wait=e||this.wait;this.hold=o||this.hold;this.domain=c.getDomainFromJid(this.jid);a=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",
ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":c.NS.BOSH});this._changeConnectStatus(c.Status.CONNECTING,null);this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(a,b,f,e,o,g,i){this.jid=a;this.sid=b;this.rid=f;this.connect_callback=e;this.domain=c.getDomainFromJid(this.jid);this.connected=this.authenticated=true;this.wait=o||this.wait;this.hold=g||this.hold;this.window=
i||this.window;this._changeConnectStatus(c.Status.ATTACHED,null)},xmlInput:function(){},xmlOutput:function(){},rawInput:function(){},rawOutput:function(){},send:function(a){if(a!==null){if(typeof a.sort==="function")for(var b=0;b<a.length;b++)this._queueData(a[b]);else typeof a.tree==="function"?this._queueData(a.tree()):this._queueData(a);this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout);
this._onIdle()},sendIQ:function(a,b,f,e){var o=null,g=this;if(typeof a.tree==="function")a=a.tree();var i=a.getAttribute("id");if(!i){i=this.getUniqueId("sendIQ");a.setAttribute("id",i)}var l=this.addHandler(function(n){o&&g.deleteTimedHandler(o);var z=n.getAttribute("type");if(z=="result")b&&b(n);else if(z=="error")f&&f(n);else throw{name:"StropheError",message:"Got bad IQ type of "+z};},null,"iq",null,i);if(e)o=this.addTimedHandler(e,function(){g.deleteHandler(l);f&&f(null);return false});this.send(a);
return i},_queueData:function(a){if(a===null||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,b){var f=new c.TimedHandler(a,b);this.addTimeds.push(f);return f},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,
b,f,e,o,g,i){a=new c.Handler(a,b,f,e,o,g,i);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(c.Status.DISCONNECTING,a);c.info("Disconnect was called because: "+a);if(this.connected){this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this));this._sendTerminate()}},_changeConnectStatus:function(a,b){for(var f in c._connectionPlugins)if(c._connectionPlugins.hasOwnProperty(f)){var e=
this[f];if(e.statusChanged)try{e.statusChanged(a,b)}catch(o){c.error(""+f+" plugin caused an exception changing status: "+o)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(g){c.error("User connection callback caused an exception: "+g)}},_buildBody:function(){var a=y("body",{rid:this.rid++,xmlns:c.NS.HTTPBIND});this.sid!==null&&a.attrs({sid:this.sid});return a},_removeRequest:function(a){c.debug("removing request");var b;for(b=this._requests.length-1;b>=0;b--)a==this._requests[b]&&
this._requests.splice(b,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];if(b.dead===null)b.dead=new Date;this._processRequest(a)},_processRequest:function(a){var b=this._requests[a],f=-1;try{if(b.xhr.readyState==4)f=b.xhr.status}catch(e){c.error("caught an error in _requests["+a+"], reqStatus: "+f)}if(typeof f=="undefined")f=-1;if(b.sends>5)this._onDisconnectTimeout();else{var o=b.age();o=!isNaN(o)&&o>Math.floor(c.TIMEOUT*
this.wait);var g=b.dead!==null&&b.timeDead()>Math.floor(c.SECONDARY_TIMEOUT*this.wait);f=b.xhr.readyState==4&&(f<1||f>=500);if(o||g||f){g&&c.error("Request "+this._requests[a].id+" timed out (secondary), restarting");b.abort=true;b.xhr.abort();b.xhr.onreadystatechange=function(){};this._requests[a]=new c.Request(b.xmlData,b.origFunc,b.rid,b.sends);b=this._requests[a]}if(b.xhr.readyState===0){c.debug("request id "+b.id+"."+b.sends+" posting");b.date=new Date;try{b.xhr.open("POST",this.service,true)}catch(i){c.error("XHR open failed.");
this.connected||this._changeConnectStatus(c.Status.CONNFAIL,"bad-service");this.disconnect();return}a=function(){b.xhr.send(b.data)};b.sends>1?setTimeout(a,Math.pow(b.sends,3)*1E3):a();b.sends++;this.xmlOutput(b.xmlData);this.rawOutput(b.data)}else c.debug("_processRequest: "+(a===0?"first":"second")+" request has readyState of "+b.xhr.readyState)}},_throttledRequestHandler:function(){this._requests?c.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):c.debug("_throttledRequestHandler called with undefined requests");
if(!(!this._requests||this._requests.length===0)){this._requests.length>0&&this._processRequest(0);this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1)}},_onRequestStateChange:function(a,b){c.debug("request id "+b.id+"."+b.sends+" state changed to "+b.xhr.readyState);if(b.abort)b.abort=false;else{var f;if(b.xhr.readyState==4){f=0;try{f=b.xhr.status}catch(e){}if(typeof f=="undefined")f=0;if(this.disconnecting)if(f>=400){this._hitError(f);
return}var o=this._requests[0]==b,g=this._requests[1]==b;if(f>0&&f<500||b.sends>5){this._removeRequest(b);c.debug("request id "+b.id+" should now be removed")}if(f==200){if(g||o&&this._requests.length>0&&this._requests[0].age()>Math.floor(c.SECONDARY_TIMEOUT*this.wait))this._restartRequest(0);c.debug("request id "+b.id+"."+b.sends+" got 200");a(b);this.errors=0}else{c.error("request id "+b.id+"."+b.sends+" error "+f+" happened");if(f===0||f>=400&&f<600||f>=12E3){this._hitError(f);if(f>=400&&f<500){this._changeConnectStatus(c.Status.DISCONNECTING,
null);this._doDisconnect()}}}f>0&&f<500||b.sends>5||this._throttledRequestHandler()}}},_hitError:function(a){this.errors++;c.warn("request errored, status: "+a+", number of errors: "+this.errors);this.errors>4&&this._onDisconnectTimeout()},_doDisconnect:function(){c.info("_doDisconnect was called");this.disconnecting=this.authenticated=false;this.streamId=this.sid=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected){this._changeConnectStatus(c.Status.DISCONNECTED,null);this.connected=
false}this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(a){try{var b=a.getResponse()}catch(f){if(f!="parsererror")throw f;this.disconnect("strophe-parsererror")}if(b!==null){this.xmlInput(b);for(this.rawInput(c.serialize(b));this.removeHandlers.length>0;){a=this.removeHandlers.pop();a=this.handlers.indexOf(a);a>=0&&this.handlers.splice(a,1)}for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());
if(this.disconnecting&&this._requests.length===0){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null;this._doDisconnect()}else{a=b.getAttribute("type");if(a!==null&&a=="terminate"){if(!this.disconnecting){a=b.getAttribute("condition");b=b.getElementsByTagName("conflict");if(a!==null){if(a=="remote-stream-error"&&b.length>0)a="conflict";this._changeConnectStatus(c.Status.CONNFAIL,a)}else this._changeConnectStatus(c.Status.CONNFAIL,"unknown");this.disconnect()}}else{var e=
this;c.forEachChild(b,null,function(o){var g,i;i=e.handlers;e.handlers=[];for(g=0;g<i.length;g++){var l=i[g];if(l.isMatch(o)&&(e.authenticated||!l.user))l.run(o)&&e.handlers.push(l);else e.handlers.push(l)}})}}}},_sendTerminate:function(){c.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});this.authenticated&&a.c("presence",{xmlns:c.NS.CLIENT,type:"unavailable"});this.disconnecting=true;this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,
this._dataRecv.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},_connect_cb:function(a){c.info("_connect_cb was called");this.connected=true;if(a=a.getResponse()){this.xmlInput(a);this.rawInput(c.serialize(a));var b=a.getAttribute("type");if(b!==null&&b=="terminate"){b=a.getAttribute("condition");a=a.getElementsByTagName("conflict");if(b!==null){if(b=="remote-stream-error"&&a.length>0)b="conflict";this._changeConnectStatus(c.Status.CONNFAIL,b)}else this._changeConnectStatus(c.Status.CONNFAIL,
"unknown")}else{if(!this.sid)this.sid=a.getAttribute("sid");if(!this.stream_id)this.stream_id=a.getAttribute("authid");if(b=a.getAttribute("requests"))this.window=parseInt(b,10);if(b=a.getAttribute("hold"))this.hold=parseInt(b,10);if(b=a.getAttribute("wait"))this.wait=parseInt(b,10);var f=b=false,e=false;a=a.getElementsByTagName("mechanism");var o,g;if(a.length>0){for(o=0;o<a.length;o++){g=c.getText(a[o]);if(g=="DIGEST-MD5")f=true;else if(g=="PLAIN")b=true;else if(g=="ANONYMOUS")e=true}if(c.getNodeFromJid(this.jid)===
null&&e){this._changeConnectStatus(c.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(y("auth",{xmlns:c.NS.SASL,mechanism:"ANONYMOUS"}).tree())}else if(c.getNodeFromJid(this.jid)===null){this._changeConnectStatus(c.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect()}else if(f){this._changeConnectStatus(c.Status.AUTHENTICATING,
null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);a=c.getNodeFromJid(this.jid);b=capptain.Crypto.HMAC(capptain.Crypto.SHA1,a,"d9f32df8743fe9489a8ccc1b57b9be4be4935ac2");this.send(h({type:"set",id:"register"}).c("query",{xmlns:"jabber:iq:register"}).c("username",a).up().c("password",b).tree());this.send(y("auth",{xmlns:c.NS.SASL,
mechanism:"DIGEST-MD5"}).tree())}else if(b){a=c.getBareJidFromJid(this.jid);a+="\u0000";a+=c.getNodeFromJid(this.jid);a+="\u0000";a+=this.pass;this._changeConnectStatus(c.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);a=j.encode(a);this.send(y("auth",{xmlns:c.NS.SASL,mechanism:"PLAIN"}).t(a).tree())}else{this._changeConnectStatus(c.Status.AUTHENTICATING,
null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(h({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:c.NS.AUTH}).c("username",{}).t(c.getNodeFromJid(this.jid)).tree())}}else{a=this._buildBody();this._requests.push(new c.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()}}}},_sasl_challenge1_cb:function(a){var b=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,f=j.decode(c.getText(a));
a=s.hexdigest(Math.random()*1234567890);var e="",o=null,g="",i;for(this.deleteHandler(this._sasl_failure_handler);f.match(b);){i=f.match(b);f=f.replace(i[0],"");i[2]=i[2].replace(/^"(.+)"$/,"$1");switch(i[1]){case "realm":e=i[2];break;case "nonce":g=i[2];break;case "host":o=i[2]}}b="xmpp/"+this.domain;if(o!==null)b=b+"/"+o;o=s.hash(c.getNodeFromJid(this.jid)+":"+e+":"+this.pass)+":"+g+":"+a;f="AUTHENTICATE:"+b;i="";i+="username="+this._quote(c.getNodeFromJid(this.jid))+",";i+="realm="+this._quote(e)+
",";i+="nonce="+this._quote(g)+",";i+="cnonce="+this._quote(a)+",";i+='nc="00000001",';i+='qop="auth",';i+="digest-uri="+this._quote(b)+",";i+="response="+this._quote(s.hexdigest(s.hexdigest(o)+":"+g+":00000001:"+a+":auth:"+s.hexdigest(f)))+",";i+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=
this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(y("response",{xmlns:c.NS.SASL}).t(j.encode(i)).tree());return false},_quote:function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),
null,"failure",null,null);this.send(y("response",{xmlns:c.NS.SASL}).tree());return false},_auth1_cb:function(){var a=h({type:"set",id:"_auth_2"}).c("query",{xmlns:c.NS.AUTH}).c("username",{}).t(c.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!c.getResourceFromJid(this.jid))this.jid=c.getBareJidFromJid(this.jid)+"/strophe";a.up().c("resource",{}).t(c.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return false},
_sasl_success_cb:function(){c.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return false},_sasl_auth1_cb:function(a){this.features=a;var b,f;for(b=0;b<a.childNodes.length;b++){f=a.childNodes[b];if(f.nodeName==
"bind")this.do_bind=true;if(f.nodeName=="session")this.do_session=true}if(this.do_bind){this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");(a=c.getResourceFromJid(this.jid))?this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:c.NS.BIND}).c("resource",{}).t(a).tree()):this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:c.NS.BIND}).tree())}else this._changeConnectStatus(c.Status.AUTHFAIL,null);return false},_sasl_bind_cb:function(a){if(a.getAttribute("type")==
"error"){c.info("SASL binding failed.");this._changeConnectStatus(c.Status.AUTHFAIL,null);return false}a=a.getElementsByTagName("bind");if(a.length>0){a=a[0].getElementsByTagName("jid");if(a.length>0){this.jid=c.getText(a[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(h({type:"set",id:"_session_auth_2"}).c("session",{xmlns:c.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(c.Status.CONNECTED,null)}}}else{c.info("SASL binding failed.");
this._changeConnectStatus(c.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(a){if(a.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(c.Status.CONNECTED,null)}else if(a.getAttribute("type")=="error"){c.info("Session creation failed.");this._changeConnectStatus(c.Status.AUTHFAIL,null)}return false},_sasl_failure_cb:function(){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);
this._sasl_challenge_handler=null}this._changeConnectStatus(c.Status.AUTHFAIL,null);return false},_auth2_cb:function(a){if(a.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(c.Status.CONNECTED,null)}else if(a.getAttribute("type")=="error"){this._changeConnectStatus(c.Status.AUTHFAIL,null);this.disconnect()}return false},_addSysTimedHandler:function(a,b){var f=new c.TimedHandler(a,b);f.user=false;this.addTimeds.push(f);return f},_addSysHandler:function(a,b,f,e,o){a=
new c.Handler(a,b,f,e,o);a.user=false;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){c.info("_onDisconnectTimeout was called");for(var a;this._requests.length>0;){a=this._requests.pop();a.abort=true;a.xhr.abort();a.xhr.onreadystatechange=function(){}}this._doDisconnect();return false},_onIdle:function(){for(var a,b,f,e;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;){b=this.removeTimeds.pop();a=this.timedHandlers.indexOf(b);
a>=0&&this.timedHandlers.splice(a,1)}var o=(new Date).getTime();e=[];for(a=0;a<this.timedHandlers.length;a++){b=this.timedHandlers[a];if(this.authenticated||!b.user){f=b.lastCalled+b.period;if(f-o<=0)b.run()&&e.push(b);else e.push(b)}}this.timedHandlers=e;if(this.authenticated&&this._requests.length===0&&this._data.length===0&&!this.disconnecting){c.info("no requests during idle cycle, sending blank request");this._data.push(null)}if(this._requests.length<2&&this._data.length>0&&!this.paused){b=this._buildBody();
for(a=0;a<this._data.length;a++)if(this._data[a]!==null)this._data[a]==="restart"?b.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":c.NS.BOSH}):b.cnode(this._data[a]).up();delete this._data;this._data=[];this._requests.push(new c.Request(b.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),b.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}if(this._requests.length>0){a=this._requests[0].age();this._requests[0].dead!==null&&this._requests[0].timeDead()>
Math.floor(c.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler();if(a>Math.floor(c.TIMEOUT*this.wait)){c.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(c.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}};w&&w(c,y,r,h,k)})(function(w,y,r,h,k){capptain.Strophe=w;capptain.$build=y;capptain.$msg=r;capptain.$iq=h;capptain.$pres=k});var JSON;JSON||(JSON={});
(function(){function w(b){return b<10?"0"+b:b}function y(b){k.lastIndex=0;return k.test(b)?'"'+b.replace(k,function(f){var e=c[f];return typeof e==="string"?e:"\\u"+("0000"+f.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+b+'"'}function r(b,f){var e,o,g,i,l=j,n,z=f[b];if(z&&typeof z==="object"&&typeof z.toJSON==="function")z=z.toJSON(b);if(typeof a==="function")z=a.call(f,b,z);switch(typeof z){case "string":return y(z);case "number":return isFinite(z)?String(z):"null";case "boolean":case "null":return String(z);case "object":if(!z)return"null";
j+=s;n=[];if(Object.prototype.toString.apply(z)==="[object Array]"){i=z.length;for(e=0;e<i;e+=1)n[e]=r(e,z)||"null";g=n.length===0?"[]":j?"[\n"+j+n.join(",\n"+j)+"\n"+l+"]":"["+n.join(",")+"]";j=l;return g}if(a&&typeof a==="object"){i=a.length;for(e=0;e<i;e+=1)if(typeof a[e]==="string"){o=a[e];if(g=r(o,z))n.push(y(o)+(j?": ":":")+g)}}else for(o in z)if(Object.prototype.hasOwnProperty.call(z,o))if(g=r(o,z))n.push(y(o)+(j?": ":":")+g);g=n.length===0?"{}":j?"{\n"+j+n.join(",\n"+j)+"\n"+l+"}":"{"+n.join(",")+
"}";j=l;return g}}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+w(this.getUTCMonth()+1)+"-"+w(this.getUTCDate())+"T"+w(this.getUTCHours())+":"+w(this.getUTCMinutes())+":"+w(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()}}var h=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
k=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,s,c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},a;if(typeof JSON.stringify!=="function")JSON.stringify=function(b,f,e){var o;s=j="";if(typeof e==="number")for(o=0;o<e;o+=1)s+=" ";else if(typeof e==="string")s=e;if((a=f)&&typeof f!=="function"&&(typeof f!=="object"||typeof f.length!=="number"))throw Error("JSON.stringify");return r("",
{"":b})};if(typeof JSON.parse!=="function")JSON.parse=function(b,f){function e(g,i){var l,n,z=g[i];if(z&&typeof z==="object")for(l in z)if(Object.prototype.hasOwnProperty.call(z,l)){n=e(z,l);if(n!==undefined)z[l]=n;else delete z[l]}return f.call(g,i,z)}var o;b=String(b);h.lastIndex=0;if(h.test(b))b=b.replace(h,function(g){return"\\u"+("0000"+g.charCodeAt(0).toString(16)).slice(-4)});if(/^[\],:{}\s]*$/.test(b.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){o=eval("("+b+")");return typeof f==="function"?e({"":o},""):o}throw new SyntaxError("JSON.parse");}})();if(!capptain.appId)throw Error("capptain.appId must be set");if(typeof capptain.sessionTimeout!="number")capptain.sessionTimeout=1E4;capptain.packageName=capptain.packageName||capptain.appId;capptain.serviceVersion="1.1.0";capptain.domain=capptain.domain||"api.prod.capptain.com";capptain.tag=capptain.tag||"CAPPTAIN";
capptain.urls=capptain.urls||{getRegisterDeviceUrl:function(){return"http://"+capptain.domain+"/track/1/register"},getXmppDiscoUrl:function(){return"http://"+capptain.domain+"/xmpp-disco"},getIpToCountryUrl:function(){return"http://"+capptain.domain+"/ip-to-country"},getHttpBindUrl:function(w){return"http://bosh."+w+"/http-bind"}};
capptain.utils=function(){var w="0123456789abcdef".split(""),y=function(h){return h<10?"0"+h:h},r={printCurrentTime:function(){var h=new Date;return y(h.getHours())+":"+y(h.getMinutes())+":"+y(h.getSeconds())},hasClass:function(h,k){return(" "+r.trim(h.className)+" ").indexOf(" "+k+" ")>-1},addClass:function(h,k){if(r.hasClass(h,k)===false)h.className=r.trim(h.className+" "+k)},removeClass:function(h,k){h.className=h.className.replace(RegExp("(^|\\s)"+k+"(?:\\s|$)"),"")},trim:String.trim||function(h){return h.replace(/^\s\s*/,
"").replace(/\s\s*$/,"")},uuid:function(){var h=[],k,j;h[12]="4";for(j=0;j<32;j++)if(!h[j]){k=0|Math.random()*16;h[j]=w[j==16?k&3|8:k]}return h.join("")},getTag:function(h,k){var j=h.getElementsByTagName(k);if(j.length)return j[0]},getText:function(h){if(h=capptain.Strophe.getText(h))return r.trim(h)},getTagText:function(h,k){return r.getText(r.getTag(h,k))},getDateFromHours:function(h){var k=new Date;k.setTime(k.getTime()+h*36E5);return k},getCookie:function(h){h+="=";var k=document.cookie.split(";"),
j;for(j=0;j<k.length;j++){for(var s=k[j];s.charAt(0)==" ";)s=s.substring(1,s.length);if(s.indexOf(h)===0)return s.substring(h.length,s.length)}return null},setCookie:function(h,k,j){j=j?"; expires="+r.getDateFromHours(j).toGMTString():"";document.cookie=h+"="+k+j+"; path=/"},deleteCookie:function(h){r.setCookie(h,"",-1)},createXHR:function(){return window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)?function(h,k,j){var s=new XDomainRequest;s.onload=function(){r.logAjaxResult(h,s);k(s);
r.destroyAjax(s)};s.onerror=function(){j(s);r.destroyAjax(s)};return s}:window.XMLHttpRequest?function(h,k,j){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(s.readyState==4){r.logAjaxResult(h,s);s.status==200?k(s):j(s);r.destroyAjax(s)}};return s}:function(){}}(),ajax:function(h,k,j,s,c){if(j=r.createXHR(k,j,s)){capptain.debug&&capptain.console.log("SEND: "+h,k);j.open(h,k,true);j.withCredentials=true;try{j.send()}catch(a){c(a)}}},destroyAjax:function(h){try{h.destroy()}catch(k){}},logAjaxResult:function(h,
k){capptain.debug&&capptain.console.log("RECV:",h,k.responseText)},getQueryParameter:function(h){var k=window.location.search.substring(1).split("&"),j;for(j=0;j<k.length;j++){var s=k[j].split("=");if(s[0]==h)return s[1]}}};return r}();
capptain.storage=capptain.storage||function(){var w=capptain.utils,y;return y=window.localStorage?{set:function(r,h,k){if(k=="session"){sessionStorage[r]=JSON.stringify(h);localStorage.removeItem(r)}else{localStorage[r]=JSON.stringify({ttl:k?w.getDateFromHours(k).getTime():undefined,val:h});sessionStorage.removeItem(r)}},get:function(r){try{var h=sessionStorage[r];if(h)return JSON.parse(h);else{h=localStorage[r];h=JSON.parse(h);if((new Date).getTime()>h.ttl){y.del(r);return null}else return h.val}}catch(k){return null}},
del:function(r){sessionStorage.removeItem(r);localStorage.removeItem(r)}}:{get:w.getCookie,set:function(r,h,k){if(k){if(k=="session")k=null}else k=876E4;w.setCookie(r,h,k)},del:w.deleteCookie}}();
capptain.console=capptain.console||function(){if(window.console){var w=navigator.userAgent.search("Android")>-1,y=w||navigator.userAgent.search("iPhone")>-1,r=Array.prototype.slice,h=function(k,j){j=["["+capptain.tag+"]"].concat(j);w||(j=[capptain.utils.printCurrentTime()].concat(j));if(!k.apply||y){var s=j.join(" ");k.call?k.call(console,s):k(s)}else k.apply(console,j)};return{log:function(){capptain.debug&&h(console.log,r.apply(arguments))},error:function(){capptain.debug&&h(console.error,r.apply(arguments))},
warn:function(){capptain.debug&&h(console.warn,r.apply(arguments))},info:function(){capptain.debug&&h(console.info,r.apply(arguments))}}}else return{log:function(){},error:function(){},warn:function(){},info:function(){}}}();
capptain.debug&&function(){var w=capptain.console;if(typeof capptain.stropheLogLevel!="number")capptain.stropheLogLevel=3;capptain.Strophe.Connection.prototype.rawInput=function(y){w.log("RECV:",y)};capptain.Strophe.Connection.prototype.rawOutput=function(y){w.log("SEND:",y)};capptain.Strophe.log=function(y,r){if(y>=capptain.stropheLogLevel)switch(y){case 0:w.log("STROPHE:",r);break;case 1:w.info("STROPHE:",r);break;case 2:w.warn("STROPHE:",r);break;case 3:case 4:w.error("STROPHE:",r)}}}();
capptain.userAgent=function(){var w=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"iPad",identity:"iPad"},{string:navigator.platform,subString:"iPod",identity:"iPod"},{string:navigator.platform,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,
subString:"hpwOS",identity:"webOS"},{string:navigator.platform,subString:"SHADOW",identity:"Samsung TV"},{string:navigator.platform,subString:"Linux",identity:"Linux"}],y,r=function(k){var j;for(j=0;j<k.length;j++){var s=k[j].string,c=k[j].prop;y=k[j].versionSearch||k[j].identity;if(s){if(s.indexOf(k[j].subString)!=-1)return k[j].identity}else if(c)return k[j].identity}},h=function(k){var j=k.indexOf(y);if(j!=-1)return parseFloat(k.substring(j+y.length+1))};return{browser:r([{string:navigator.userAgent,
subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"hpwOS",identity:"webOS",versionSearch:"hpwOS"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",
identity:"Konqueror"},{string:navigator.appName,subString:"Maple",identity:"Maple"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Internet Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Android",identity:"WebKit",versionSearch:"Version"},{string:navigator.userAgent,subString:"Gecko",
identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}]),version:h(navigator.userAgent)||h(navigator.appVersion),platform:r(w)}}();
capptain.agent=function(){var w=capptain.console,y=capptain.utils,r=capptain.storage,h=y.trim,k=y.uuid,j=y.getTag,s=y.getTagText,c=capptain.Strophe,a=capptain.$build,b=capptain.$pres,f=capptain.$iq,e=capptain.$msg,o=capptain.MD5.hexdigest,g=/^[a-zA-Z][a-zA-Z_0-9]*$/,i,l=false,n=false,z,q,u={},v={};v.prev=v;v.next=v;var p=0,A={},C=[],E,F=[],L=0,H,Q="capptain."+capptain.appId+".sid",D=r.get(Q),R="capptain."+capptain.appId+".locid",K,T="capptain."+capptain.appId+".activityid",O=null,N={},S,I=function(d){this.message=
d;this.name="["+capptain.tag+"] Error"};I.prototype=Error();var Z=function(){var d=null,m=null,t={},x=null;return{start:function(){this.stop();x=setInterval(function(){if(d){var B;B=r.get(T);if(!B||B===m){r.set(T,m,0.025);B=true}else B=false;B?F.push(d):r.set(Q,D,0.05)}for(var J in t)t.hasOwnProperty(J)&&F.push(t[J]);aa()},6E4)},setCurrentActivityLog:function(B){if(B.log&&B.timestamp){d={log:this.cloneWithRepost(B.log),timestamp:B.timestamp};m=B.log.tree().getAttribute("id");r.set(T,m,0.025)}},removeCurrentActivityLog:function(){r.get(T)===
m&&r.del(T);m=d=null},addJobLog:function(B,J){if(B&&J.log&&J.timestamp)t[B]={log:this.cloneWithRepost(J.log),timestamp:J.timestamp}},removeJobLog:function(B){delete t[B]},cloneWithRepost:function(B){var J=capptain.$build(B.nodeTree.nodeName),ba=B.nodeTree.attributes;B=B.nodeTree.childNodes;var U,da={repost:"true"};for(U=0;U<ba.length;U++)da[ba[U].name]=ba[U].value;J.attrs(da);for(U=0;U<B.length;U++)J.cnode(B[U]).up();return J},stop:function(){x&&clearInterval(x)}}}(),ca=function(){if(!capptain.deviceId){var d=
r.get("capptain.deviceId");d||(d=o(k()));r.set("capptain.deviceId",d);capptain.deviceId=d}d=capptain.deviceId;var m=capptain.appId,t="capptain."+m+".register";if(r.get(t)!=d){var x=y.getQueryParameter("capptain.referrer");if(x)try{JSON.parse(unescape(x))}catch(B){w.error("Invalid Capptain Referrer (must be JSON)");x=null}m=capptain.urls.getRegisterDeviceUrl()+"?deviceid="+d+"&appid="+m;if(x)m+="&extras="+x;y.ajax("POST",m,function(){w.info("Device registered successfully");r.set(t,d)},function(){w.error("Cannot register device")},
ea)}if(x=r.get("capptain.connection"))try{x=JSON.parse(x)}catch(J){}if(x)if(capptain.Strophe.getNodeFromJid(x.jid)==capptain.deviceId&&x.apiDomain==capptain.domain){E=x.epoch;fa(capptain.Strophe.getNodeFromJid(x.jid),{domain:capptain.Strophe.getDomainFromJid(x.jid),serviceDomain:x.serviceDomain})}else r.del("capptain.connection");x=capptain.userAgent;if((m=navigator.language||navigator.browserLanguage)&&m.length>2)m=m.substring(0,2);x={serviceVersion:capptain.serviceVersion,locale:m,firmwareName:x.browser,
firmwareVersion:x.version,phoneModel:x.platform,screenSize:screen.width+"x"+screen.height,timeZoneOffset:-(new Date).getTimezoneOffset()};if(capptain.appVersionName)x.applicationVersionName=capptain.appVersionName;if(capptain.appVersionCode)x.applicationVersionCode=capptain.appVersionCode;$(capptain.onInfoUpdated,[x]);x=JSON.stringify(x);H=o(x);m="capptain."+capptain.appId+".infoid";H!=r.get(m)&&G(a("info",{id:k(),infoid:H}).t(x));r.set(m,H,1);for(x=0;x<C.length;x++){m=C[x];try{Y[m.name].apply(Y,
m.args)}catch(ba){w.error(ba)}}ca=C=null},$=function(d,m){if(d)if(d.constructor===Array){var t;for(t=0;t<d.length;t++)try{var x=d[t];x.apply(x,m)}catch(B){w.error(B)}}else w.error(d+" must be wrapped in an array.")},ga=function(d){d.prev=v.prev;d.next=v;v.prev.next=d;v.prev=d},ia=function(d,m,t){var x=u[d];if(x){x.prev.next=x.next;x.next.prev=x.prev;ga(x);m(x.data)}else if(A[d])A[d].push(m);else{A[d]=[m];ha(d,t)}},ha=function(d,m){var t=capptain.urls.getXmppDiscoUrl()+"?deviceid="+d;if(m!==false)t+=
"&appid="+capptain.appId;y.ajax("GET",t,function(x){x=JSON.parse(x.responseText);fa(d,x);var B=A[d],J;for(J=0;J<B.length;J++)B[J](x);delete A[d]},function(x){x=x.status;switch(x){case 410:w.warn("XMPP disco failed (empty logs spool): ",x);F=[];L=0;break;case 403:w.warn("XMPP disco failed: ",x);break;default:w.error("XMPP disco failed, retrying in 5s");setTimeout(function(){ha(d)},5E3)}},ea)},ea=function(d){w.error("Fatal error:",JSON.stringify(d));G=function(){};F=[];L=0},fa=function(d,m){var t={data:m,
deviceId:d};u[d]=t;ga(t);if(p==10){t=v.next;t.prev.next=t.next;t.next.prev=t.prev;delete u[t.deviceId]}else p++},ja=function(d){i=new c.Connection(d);i.addHandler(ua,"urn:ubikod:ermin:push:0","message",null,null,q);i.addHandler(va,"urn:ubikod:ermin:0","message")},ka=function(){r.del("capptain.connection");l=false;E=null;L=0},la=function(){},wa=function(){var d=1E3;la=function(){d=1E3};return function(){if(d<36E5)d*=2;if(d>36E5)d=36E5;w.log("Waiting "+d+"ms before reconnecting...");setTimeout(function(){ka();
Y.connect()},d)}}(),ma=function(){Z.start();$(capptain.onConnected,[]);xa()},oa=function(d){switch(d){case c.Status.ATTACHED:w.info("Strophe connection attached");setTimeout(function(){l=true;aa();ma()},300);break;case c.Status.CONNECTED:w.info("Strophe connection established");l=true;i.send(b());i.sendIQ(f({to:z,type:"set"}).c("epoch",{xmlns:"urn:ubikod:ermin:0"}),function(){E=(new Date).getTime();aa()},function(){w.error("Epoch error")});na();ma();break;case c.Status.DISCONNECTED:case c.Status.CONNFAIL:case c.Status.AUTHFAIL:case c.Status.ERROR:w.info("Strophe connection has been terminated");
Z.stop();$(capptain.onDisconnected,[]);n?ka():wa()}},na=function(){i.sendIQ(f({type:"get",to:q}).c("messages",{xmlns:"urn:ubikod:ermin:push:0",appid:capptain.appId}),function(d){(d=j(d,"messages"))&&c.forEachChild(d,"message",function(m){var t=m.getAttribute("id"),x=s(m,"payload");m=m.getAttribute("replyto");$(capptain.onPushMessageReceived,[t,x,m])})})},ua=function(d){(d=j(d,"tickle"))&&d.getAttribute("appid")==capptain.appId&&na();return true},va=function(d){if(d.getAttribute("type")!="error"){var m=
j(d,"deviceMessage");if(m){if(d=d.getAttribute("from"))d=c.getNodeFromJid(d);if(m.getAttribute("packageName")==capptain.packageName){m=y.getText(m);i.send(e({to:i.domain}));$(capptain.onDeviceMessageReceived,[d,m])}}}return true},aa=function(){if(E&&l&&L===0&&F.length>0){var d=f({to:z,type:"set"}).c("log",{xmlns:"urn:ubikod:ermin:0",appid:capptain.appId});L=F.length;var m;for(m=0;m<L;m++){F[m].log.attrs({toffset:F[m].timestamp-E});d.cnode(F[m].log.tree()).up()}i.sendIQ(d,function(){F=F.slice(L);L=
0;la();aa()},function(t){w.error("Error sending logs");L=0;if(t.getAttribute("type")==="error"){w.info("Application disabled, the connection is about to stop");n=true;Y.disconnect();if((t=j(t,"disabled"))&&t.getAttribute("hard")==="true"){F=[];L=0}}})}},G=function(d){d={log:d,timestamp:(new Date).getTime()};F.push(d);aa();return d},M=function(d,m){if(H==null){C.push({name:d,args:m});return true}},P=function(d){if(d==undefined)throw new I("Name cannot be null.");d=h(d);if(d.length===0)throw new I("Empty string not allowed.");
if(d.length>64)throw new I("Name cannot exceed 64 characters.");return d},pa=function(d){if(d)for(var m in d)if(d.hasOwnProperty(m)&&g.test(m)===false)throw new I('The key "'+m+'" of "'+JSON.stringify(d)+'" must follow the format '+g+".");},V=function(d){if(d){pa(d);d=JSON.stringify(d);if(d.length>1024)throw new I("Extras are limited to 1024 characters.");if(d[0]!="{")throw new I("Extras must be a non null object (and not an array)");return d}},W=function(d,m){m&&d.c("x").t(m).up()},X=function(d){(K=
r.get(R))&&d.attrs({locid:K})},qa=function(){w.error("Unable to get the country code for this device")},xa=function(){K=r.get(R);y.ajax("GET",capptain.urls.getIpToCountryUrl(),function(d){d=JSON.parse(d.responseText);if(d.countryCode){d=ra({countrycode:d.countryCode});var m=o(c.serialize(d));if(!K||K!==m){K=m;r.set(R,m,1);G(sa(d))}}},qa,qa)},ra=function(d){var m=a("geoloc",{xmlns:"http://jabber.org/protocol/geoloc"});typeof d.countrycode=="string"&&m.c("countrycode").t(d.countrycode).up();typeof d.latitude==
"number"&&m.c("lat").t(""+d.latitude).up();typeof d.locality=="string"&&m.c("locality").t(d.locality).up();typeof d.longitude=="number"&&m.c("lon").t(""+d.longitude).up();typeof d.region=="string"&&m.c("region").t(d.region).up();return m=m.tree()},sa=function(d){return a("location",{id:k(),infoid:H,locid:K}).cnode(d).up()},ta=function(){var d=a("endSession",{sid:D});X(d);G(d);S=O=D=null;r.del(Q)},Y={connect:function(){ca&&ca();ia(capptain.deviceId,function(d){z="logger."+d.domain;q="push."+d.serviceDomain;
var m=capptain.urls.getHttpBindUrl(d.domain);try{var t=r.get("capptain.connection");if(!t)throw undefined;t=JSON.parse(t);r.del("capptain.connection");ja(m);i.attach(t.jid,t.sid,t.rid-1,oa)}catch(x){x&&w.warn("Resume connection failed ",x);r.del("capptain.connection");ja(m);m=capptain.Crypto.HMAC(capptain.Crypto.SHA1,capptain.deviceId,"accf24cc95da85fee44418125ea16091dad29939");i.connect(capptain.deviceId+"@"+d.domain,m,oa)}})},disconnect:function(){i.disconnect()},pause:function(){if(l){i.pause();
r.set("capptain.connection",JSON.stringify({jid:i.jid,sid:i.sid,rid:i.rid,epoch:E,apiDomain:capptain.domain,serviceDomain:u[capptain.deviceId].data.serviceDomain}),1/60/2)}},sendMessageToDevice:function(d,m,t){ia(d,function(x){if(l){t=t||capptain.packageName;var B;B=t.indexOf(".")==-1?"":"/"+t;i.send(e({to:d+"@"+x.domain+B,id:k()}).c("deviceMessage",{xmlns:"urn:ubikod:ermin:0",packageName:t}).t(m).tree())}},false)},startActivity:function(d,m){if(!M("startActivity",[d,m])){if(d)d=P(d);m=V(m);var t=
r.get(Q);if(!D&&t)D=t;if(!D||!t){D=k();G(a("startSession",{sid:D,infoid:H}))}else if(S){clearTimeout(S);S=null}r.set(Q,D,0.05);O=d?d:"default";$(capptain.onActivityChanged,[O]);t=a("activity",{id:k(),sid:D});d&&t.attrs({name:d});W(t,m);t=G(t);Z.setCurrentActivityLog(t)}},endActivity:function(){if(!M("endActivity",[]))if(S)throw new I("Activity already ended (session is idle)");else if(D){if(capptain.sessionTimeout>0){O="idle";G(a("idle",{id:k(),sid:D}));S=setTimeout(ta,capptain.sessionTimeout)}else ta();
Z.removeCurrentActivityLog()}else throw new I("Cannot end activity, no activity started.");},getActivity:function(){return O},startJob:function(d,m){if(!M("startJob",[d,m])){d=P(d);m=V(m);if(N[d])throw new I('Job "'+d+'" already started');var t=k();N[d]=t;var x=a("startJob",{infoid:H,jobid:t,name:d});W(x,m);x=G(x);Z.addJobLog(t,x)}},endJob:function(d){if(!M("endJob",[d])){d=P(d);if(N[d]){var m=N[d];delete N[d];d=a("endJob",{jobid:m});X(d);G(d);Z.removeJobLog(m)}else throw new I('Cannot end job "'+
d+'" : not started.');}},sendEvent:function(d,m){if(!M("sendEvent",[d,m])){d=P(d);m=V(m);var t=a("event",{id:k(),name:d,infoid:H});X(t);W(t,m);G(t)}},sendSessionEvent:function(d,m){if(!M("sendSessionEvent",[d,m])){d=P(d);m=V(m);if(!D)throw new I("Cannot send session event: session not started.");var t=a("event",{id:k(),name:d,infoid:H,sid:D});X(t);W(t,m);G(t)}},sendJobEvent:function(d,m,t){if(!M("sendJobEvent",[d,m,t])){d=P(d);m=P(m);t=V(t);var x=N[m];if(!x)throw new I('Cannot send job event, no job: "'+
m+'"');d=a("event",{id:k(),name:d,infoid:H,jobid:x});X(d);W(d,t);G(d)}},sendError:function(d,m){if(!M("sendError",[d,m])){d=P(d);m=V(m);var t=a("error",{id:k(),name:d,infoid:H});X(t);W(t,m);G(t)}},sendSessionError:function(d,m){if(!M("sendSessionError",[d,m])){d=P(d);m=V(m);if(!D)throw new I("Cannot send session error: session not started.");var t=a("error",{id:k(),name:d,infoid:H,sid:D});X(t);W(t,m);G(t)}},sendJobError:function(d,m,t){if(!M("sendJobError",[d,m,t])){d=P(d);m=P(m);t=V(t);var x=N[m];
if(!x)throw new I('Cannot send job error, no job: "'+m+'"');d=a("error",{id:k(),name:d,infoid:H,jobid:x});X(d);W(d,t);G(d)}},sendCrash:function(d,m){if(!M("sendCrash",[d,m])){d=h(d);if(d.length===0)throw new I("Empty key is not allowed.");m=h(m);if(m.length===0)throw new I("Empty stack trace is not allowed");var t=o(d);if(m.length>4096)m=m.substr(0,4096);t=a("crash",{id:k(),crashid:t,infoid:H}).t(m);D&&t.attrs({sid:D});G(t)}},sendLocation:function(d){if(!M("sendLocation",[d])){d=ra(d);var m=o(c.serialize(d));
K=m;r.set(R,m,1);G(sa(d))}},sendAppInfo:function(d){if(!M("sendAppInfo",[d])){pa(d);d=JSON.stringify(d);if(d.length>1024)throw new I("AppInfo data is limited to 1024 characters.");G(a("appInfo").t(d))}},_send:function(d){l&&i.send(d)},sendReachFeedback:function(d,m,t,x){if(!M("sendReachFeedback",[d,m,t,x])){d=a("reach",{kind:d,contentid:m,status:t});x&&typeof x==="object"&&d.t(JSON.stringify(x));G(d)}}};D&&Y.endActivity();capptain.disableAutoConnect||Y.connect();return Y}();if(!capptain.reach)capptain.reach={};capptainReachContent={actionContent:function(){},exitContent:function(){}};
(function(){var w=capptain.console,y=capptain.storage,r=capptain.utils.getText,h=capptain.utils.getTagText,k=capptain.utils.addClass,j=capptain.utils.removeClass,s="capptain."+capptain.appId+".reach",c=y.get(s)||[],a,b,f=function(q){if(q.expiry){var u=q.expiry.date,v=+new Date;if(q.expiry.isLocalTimeZone===true)v-=(new Date).getTimezoneOffset()*6E4;if(v>=u)return true}return false},e=function(q){var u,v=function(C,E){q.replyto&&capptain.agent.sendReachFeedback(q.kind,q.id,C,E)};if(q.kind==="datapush"){q.drop=
function(){v("dropped")};q.actionContent=function(){v("content-actioned")};q.exitContent=function(){v("content-exited")}}else{var p=function(C,E){if(!u&&a==q){v(C,E);c.splice(b,1);y.set(s,c);u=true;a=null;g()}};q.drop=function(){p("dropped")};q.displayInAppNotification=function(){v("in-app-notification-displayed")};q.actionInAppNotification=function(){v("in-app-notification-actioned")};q.exitInAppNotification=function(){p("in-app-notification-exited")};q.displayContent=function(){v("content-displayed")};
q.actionContent=function(){p("content-actioned")};q.exitContent=function(){p("content-exited")};switch(q.kind){case "notifAnnouncement":q.actionInAppNotification=function(){p("in-app-notification-actioned")};break;case "poll":var A={};q.fillAnswer=function(C,E){A[C]=E};q.actionContent=function(){p("content-actioned",A)}}capptainReachContent.actionContent=q.actionContent;capptainReachContent.exitContent=q.exitContent}},o=function(q){if(!a){var u=capptain.agent.getActivity();return u?typeof q.behavior==
"string"||q.behavior.indexOf(u)>-1:q.behavior=="any"}},g=function(){var q;for(q=0;q<c.length;q++){var u=c[q];if(o(u)&&i(u)){b=q;break}}},i=function(q){a=q;e(q);if(f(q)){q.drop();return false}try{capptain.reach.onContentReceived(q);return true}catch(u){w.error("capptain.reach.onContentReceived failed:",u);q.drop();return false}},l=function(q){q.action.url&&setTimeout(function(){location=q.action.url},500)},n={htmlClassName:"capptain_category_default",htmlNotificationId:"capptain_notification_area",
htmlOverlayId:"capptain_overlay",onContentReceived:null,onNotificationActioned:null};n.onContentReceived=typeof capptain.reach.onContentReceived==="function"?capptain.reach.onContentReceived:function(q){var u=document.getElementById("capptain_notification_area");if(!u)throw"No existing HTMLElement for #capptain_notification_area";q.notification.hasIcon?j(u,"no-icon"):k(u,"no-icon");if(q.notification.hasContent){document.getElementById("capptain_notification_title").innerHTML=q.notification.title;
document.getElementById("capptain_notification_message").innerHTML=q.notification.message;j(u,"no-content")}else k(u,"no-content");var v=document.getElementById("capptain_notification_image");if(v){for(var p=v.childNodes,A=0;A<p.length;A++)v.removeChild(p[A]);if(q.notification.image){p=document.createElement("img");p.setAttribute("alt","Image notification");p.setAttribute("src",q.notification.image);v.appendChild(p)}}if(q.notification.closeable){document.getElementById("capptain_notification_close").onclick=
function(C){u.style.visibility="hidden";C=C||window.event;if(C.stopPropagation)C.stopPropagation();else C.cancelBubble=true;q.exitInAppNotification()};j(u,"no-close")}else k(u,"no-close");u.onclick=function(){u.style.visibility="hidden";if(q.kind=="notifAnnouncement"){q.actionInAppNotification();l(q)}else try{capptain.reach.onNotificationActioned(q)}catch(C){w.error("capptain.reach.onNotificationActioned failed:",C);q.drop()}};u.style.visibility="visible";q.displayInAppNotification()};n.onNotificationActioned=
typeof capptain.reach.onNotificationActioned==="function"?capptain.reach.onNotificationActioned:function(q){q.actionInAppNotification();var u=document.getElementById("capptain_overlay"),v=document.getElementById("capptain_overlay_title"),p=document.getElementById("capptain_overlay_close"),A=document.getElementById("capptain_overlay_body"),C=document.getElementById("capptain_overlay_action"),E=document.getElementById("capptain_overlay_exit"),F=document.getElementById("capptain_overlay_poll");if(!u)throw"No existing HTMLElement for #capptain_overlay";
var L={mask:null,create:function(){this.mask=document.createElement("div");this.mask.onclick=function(){Q()};k(this.mask,"capptain_mask");document.body.appendChild(this.mask)},remove:function(){document.body.removeChild(this.mask)},setOverlayPosition:function(O){var N=document.documentElement;O.style.top="30px";O.style.left=(N.clientWidth-O.offsetWidth)/2+"px"}};if(q.title===undefined||q.title==="")v.style.display="none";else{v.style.display="block";v.innerHTML=q.title}A.innerHTML=q.body;j(u,"no-action");
j(u,"no-exit");if(q.kind==="announcement"&&q.type==="text/html"){q.action.label||k(u,"no-action");q.exit.label||k(u,"no-exit")}C.innerHTML=q.action.label||"OK";E.innerHTML=q.exit.label||"Cancel";var H=function(){u.style.visibility="hidden";L.remove()};v=function(){H();if(q.kind!="announcement")for(var O=F.getElementsByTagName("input"),N=0;N<O.length;N++){var S=O[N];S.checked&&q.fillAnswer(S.questionId,S.choiceId)}q.actionContent();l(q)};var Q=function(){H();q.exitContent()};C.onclick=v;E.onclick=
Q;if(p)p.onclick=Q;capptainReachContent.actionContent=v;for(capptainReachContent.exitContent=Q;F.firstChild;)F.removeChild(F.firstChild);if(q.kind=="poll"){p=q.questions;for(C=0;C<p.length;C++){E=p[C];v=document.createElement("fieldset");A=document.createElement("legend");A.innerHTML=E.title;v.appendChild(A);A=E.choices;var D;for(D=0;D<A.length;D++){var R=A[D],K=document.createElement("input");K.setAttribute("type","radio");K.setAttribute("name","capptain_overlay_poll_question_"+E.id);K.setAttribute("id",
"capptain_overlay_poll_choice_"+R.id);R["default"]&&K.setAttribute("checked",true);K.questionId=E.id;K.choiceId=R.id;var T=document.createElement("label");T.setAttribute("for","capptain_overlay_poll_choice_"+R.id);T.innerHTML=R.title;v.appendChild(K);v.appendChild(T);v.appendChild(document.createElement("br"))}F.appendChild(v)}}L.create();L.setOverlayPosition(u);u.style.visibility="visible";q.displayContent()};capptain.onPushMessageReceived=capptain.onPushMessageReceived||[];capptain.onPushMessageReceived.push(function(q,
u,v){if(window.DOMParser){parser=new DOMParser;q=parser.parseFromString(u,"text/xml")}else{q=new ActiveXObject("Microsoft.XMLDOM");q.async="false";q.loadXML(u)}u=q.documentElement;if(!(!u||u.getAttribute("xmlns")!="urn:ubikod:ermin:reach:0")){switch(u.nodeName){case "announcement":case "poll":case "notifAnnouncement":case "datapush":break;default:return}v={id:u.getAttribute("id"),category:u.getAttribute("category")?u.getAttribute("category"):null,kind:u.nodeName,replyto:v,notification:{closeable:true,
hasIcon:true,hasContent:true},behavior:"any",exit:{},action:{}};switch(v.kind){case "announcement":case "datapush":v.type=u.getAttribute("type");break;case "poll":v.questions=[]}u=u.childNodes;for(q=0;q<u.length;q++){var p=u[q];switch(p.nodeName){case "title":v.title=r(p);break;case "body":if(p=r(p))v.body=p.replace(/{deviceid}/g,capptain.deviceId);break;case "notification":var A=v.notification;A.title=h(p,"title")?h(p,"title"):"";A.message=h(p,"message")?h(p,"message"):"";A.image=h(p,"image");if(A.image)A.image=
"data:image/png;base64,"+A.image;if(p.getAttribute("closeable")==="false")A.closeable=false;if(p.getAttribute("icon")==="false")A.hasIcon=false;if(!v.notification.title&&!v.notification.message)A.hasContent=false;break;case "expiry":A=p.getAttribute("localtz")==="true"?true:false;p=r(p);v.expiry={isLocalTimeZone:A,date:window.parseInt(p,10)};break;case "action":A=v.action;A.label=h(p,"label");if(p=h(p,"url"))A.url=p.replace(/{deviceid}/g,capptain.deviceId);break;case "exit":v.exit.label=h(p,"label");
break;case "behavior":if(p.getElementsByTagName("session").length)v.behavior="session";else{A=p.getElementsByTagName("activity");if(A.length){var C=[];for(p=0;p<A.length;p++)C[p]=r(A[p]);v.behavior=C}}break;case "question":A=[];C={id:p.getAttribute("id"),title:h(p,"title"),choices:A};var E=p.getElementsByTagName("choice");for(p=0;p<E.length;p++){var F=E[p];A[p]={id:F.getAttribute("id"),title:r(F),"default":F.getAttribute("default")=="true"}}v.questions.push(C)}}if(v.kind=="datapush"){u=undefined;
e(v);if(f(v))v.drop();else{switch(v.type){case "text/plain":if(typeof capptain.reach.onDataPushStringReceived=="function")u=capptain.reach.onDataPushStringReceived(v.body);break;case "text/base64":if(typeof capptain.reach.onDataPushBase64Received=="function"){u=capptain.Crypto;u=u.charenc.Binary.bytesToString(u.util.base64ToBytes(v.body));u=capptain.reach.onDataPushBase64Received(u,v.body)}}if(u===true)v.actionContent();else u===false?v.exitContent():v.drop()}}else{c.push(v);y.set(s,c);if(o(v)){b=
c.length-1;i(v)}}}});capptain.onActivityChanged=capptain.onActivityChanged||[];capptain.onActivityChanged.push(g);capptain.reach.categories=capptain.reach.categories||{};capptain.reach.categories.capptain_category_default=n;var z=function(q,u){if(q.category&&capptain.reach.categories){var v=capptain.reach.categories[q.category];if(v&&v[u]){v[u](q);return}}n[u](q)};capptain.reach.onContentReceived=function(q){var u=q.category,v=capptain.reach.categories&&capptain.reach.categories[u]?capptain.reach.categories[u]:
n;u=v.htmlClassName?v.htmlClassName:n.htmlClassName;var p=document.getElementById(v.htmlNotificationId?v.htmlNotificationId:n.htmlNotificationId);v=document.getElementById(v.htmlOverlayId?v.htmlOverlayId:n.htmlOverlayId);if(p)p.className=u;if(v)v.className=u;z(q,"onContentReceived")};capptain.reach.onNotificationActioned=function(q){z(q,"onNotificationActioned")}})();
